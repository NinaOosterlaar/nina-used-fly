---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import CountryMapSpecific from '../components/CountryMapSpecific.astro';
import { SITE_TITLE } from '../consts';
import { getCountryDescription, getCountryFlag, countryConfig } from '../config/countries';
import { getEnrichedPostsForCountry } from '../utils/blog-db';
import { url } from '../utils/url';
import { resolveImageUrl } from '../utils/image';

export async function getStaticPaths() {
	// Get all countries from the config
	const countries = Object.keys(countryConfig);
	
	return countries.map((countryName) => ({
		params: { country: countryName.toLowerCase().replace(/\s+/g, '-') },
		props: { countryName },
	}));
}

const { country } = Astro.params;
const { countryName } = Astro.props;

// Get all enriched posts for this country (with markdown frontmatter)
const countryPosts = await getEnrichedPostsForCountry(countryName);

// Group posts by type
const travelPosts = countryPosts.filter(post => post.travelTitle);
const planPosts = countryPosts.filter(post => post.planTitle);

console.log(`Country posts for ${countryName}:`, countryPosts);
console.log(`Travel posts:`, travelPosts);
console.log(`Plan posts:`, planPosts);
---

<!DOCTYPE html>
<html lang="en">
	<head>
		<BaseHead title={`${countryName} - ${SITE_TITLE}`} description={`My travels and adventures in ${countryName}`} />
	</head>
	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QVH8372V0"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-9QVH8372V0');
	</script>
	<body>
		<Header />
		<main>
			<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
				<!-- Page Header -->
				<div class="text-center mb-12">
					<h1 class="title-font text-5xl md:text-6xl font-bold text-pink-400 mb-6 leading-tight">
						{getCountryFlag(countryName)} {countryName}
					</h1>
					<p class="text-gray-600 max-w-4xl mx-auto md:text-xl">
						{getCountryDescription(countryName)}
					</p>
					<p class="text-pink-500 font-medium mt-4">
						{countryPosts.length} post{countryPosts.length !== 1 ? 's' : ''} found
					</p>
				</div>

				<!-- Posts organized by category -->
				{countryPosts.length > 0 ? (
					<div class="space-y-12">
						<!-- Travel Posts Section -->
						{travelPosts.length > 0 && (
							<section>
								<h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
									<i class="fas fa-plane-departure text-pink-500 mr-3"></i>
									Travel Posts
									<span class="ml-3 text-lg text-pink-500 font-normal">({travelPosts.length})</span>
								</h2>
								<div class={`grid gap-6 ${travelPosts.length === 1 ? "max-w-xl mx-auto grid-cols-1" : travelPosts.length === 2 ? "max-w-4xl mx-auto grid-cols-1 sm:grid-cols-2" : "grid-cols-1 md:grid-cols-2 lg:grid-cols-3"}`}>
									{travelPosts.map((postData) => (
									<a 
										href={url(postData.markdownData?.url || `/blog/post-${postData.id}`)}
										class="post-card bg-white rounded-xl overflow-hidden shadow-md hover:shadow-xl transition-shadow duration-300 block"
									>
										<div class={`overflow-hidden ${travelPosts.length <= 2 ? "h-80" : "h-48"}`}>
											{postData.markdownData?.heroImage ? (
												<img 
													src={resolveImageUrl(postData.markdownData.heroImage)} 
													alt={postData.title}
													class="w-full h-full object-cover"
												/>
											) : (
												<div class="w-full h-full bg-gradient-to-br from-pink-100 to-blue-100 flex items-center justify-center">
													<div class="text-center">
														<i class="fas fa-camera text-4xl text-pink-400 mb-2"></i>
														<p class="text-gray-600 text-sm">Photo coming soon</p>
													</div>
												</div>
											)}
										</div>
										<div class="p-6">
											<div class="flex items-center text-sm text-pink-400 mb-2">
												<i class="fas fa-map-marker-alt mr-1"></i>
												<span>{postData.location}</span>
												{postData.startDate && (
													<>
														<span class="mx-2">•</span>
														<span>
															{new Date(postData.startDate).toLocaleDateString('en-GB')}
															{postData.endDate && (
																<> - {new Date(postData.endDate).toLocaleDateString('en-GB')}</>
															)}
														</span>
													</>
												)}
											</div>
											<h3 class="title-font text-xl font-semibold text-gray-800 mb-3">
												{postData.title.replace(/_/g, ' ')}
											</h3>
											<p class="text-gray-600 mb-4">
												{postData.markdownData?.description || `Read about my experiences and discoveries in this beautiful location in ${countryName}.`}
											</p>
											<span class="text-pink-500 font-medium">Read more</span>
										</div>
									</a>
									))}
								</div>
							</section>
						)}

						<!-- Plan Posts Section -->
						{planPosts.length > 0 && (
							<section>
								<h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
									<i class="fas fa-map text-pink-500 mr-3"></i>
									Plan Posts
									<span class="ml-3 text-lg text-pink-500 font-normal">({planPosts.length})</span>
								</h2>
								<div class={`grid gap-6 ${planPosts.length === 1 ? "max-w-xl mx-auto grid-cols-1" : planPosts.length === 2 ? "max-w-4xl mx-auto grid-cols-1 sm:grid-cols-2" : "grid-cols-1 md:grid-cols-2 lg:grid-cols-3"}`}>
									{planPosts.map((postData) => (
									<a 
										href={url(postData.markdownData?.url || `/blog/post-${postData.id}`)}
										class="post-card bg-white rounded-xl overflow-hidden shadow-md hover:shadow-xl transition-shadow duration-300 block"
									>
										<div class={`overflow-hidden ${planPosts.length <= 2 ? "h-80" : "h-48"}`}>
											{postData.markdownData?.heroImage ? (
												<img 
													src={resolveImageUrl(postData.markdownData.heroImage)} 
													alt={postData.title}
													class="w-full h-full object-cover"
												/>
											) : (
												<div class="w-full h-full bg-gradient-to-br from-pink-100 to-blue-100 flex items-center justify-center">
													<div class="text-center">
														<i class="fas fa-camera text-4xl text-pink-400 mb-2"></i>
														<p class="text-gray-600 text-sm">Photo coming soon</p>
													</div>
												</div>
											)}
										</div>
										<div class="p-6">
											<div class="flex items-center text-sm text-pink-400 mb-2">
												<i class="fas fa-map-marker-alt mr-1"></i>
												<span>{postData.location}</span>
												{postData.startDate && (
													<>
														<span class="mx-2">•</span>
														<span>
															{new Date(postData.startDate).toLocaleDateString('en-GB')}
															{postData.endDate && (
																<> - {new Date(postData.endDate).toLocaleDateString('en-GB')}</>
															)}
														</span>
													</>
												)}
											</div>
											<h3 class="title-font text-xl font-semibold text-gray-800 mb-3">
												{postData.title.replace(/_/g, ' ')}
											</h3>
											<p class="text-gray-600 mb-4">
												{postData.markdownData?.description || `Read about my experiences and discoveries in this beautiful location in ${countryName}.`}
											</p>
											<span class="text-pink-500 font-medium">Read more</span>
										</div>
									</a>
									))}
								</div>
							</section>
						)}
					</div>
				) : (
					<div class="text-center py-12">
						<div class="text-gray-400 mb-4">
							<i class="fas fa-camera text-6xl"></i>
						</div>
						<h3 class="text-xl font-semibold text-gray-600 mb-2">No {countryName} Adventures Yet</h3>
						<p class="text-gray-500">
							I haven't shared any stories from {countryName} yet, but stay tuned for upcoming adventures!
						</p>
					</div>
				)}

				<!-- Country Map -->
				<CountryMapSpecific countryName={countryName} />
			</div>
		</main>
		<Footer />
	</body>
</html>
