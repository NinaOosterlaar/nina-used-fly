---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE } from '../consts';
import { db } from '../db';
import { plans, post } from '../db/schema';
import { eq, and, sql, count } from 'drizzle-orm';
import fidoughImage from '../assets/fidough.png';
import { getPlanPreview, getPlanHeroImage } from '../config/plans';
import { travelTitleToNormal } from '../utils/blog-db';

// Get all plans associated with blog posts
const planWithPosts = await db.select({
	planId: plans.id,
	title: plans.title,
	postCount: count(post.id),
	})
	.from(plans)
	.innerJoin(post, eq(post.planId, plans.id))
	.groupBy(plans.id, plans.title)
	.orderBy(sql`MAX(${post.createdAt}) DESC`) // Order by most recent post
	.all();

console.log(planWithPosts);

const defaultImage = fidoughImage.src;
---

<!DOCTYPE html>
<html lang="en">
	<head>
		<BaseHead title={`Plans - ${SITE_TITLE}`} description="My upcoming travel plans and destinations" />
	</head>
	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QVH8372V0"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-9QVH8372V0');
	</script>
	<body>
		<Header />
		<main>
			<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
				<!-- Page Header -->
				<div class="text-center mb-8">
					<h1 class="title-font text-5xl md:text-6xl font-bold text-pink-400 mb-6 leading-tight">
						Plans
					</h1>
					<p class="text-gray-600 max-w-3xl mx-auto md:text-xl">
						Explore my upcoming travel plans and dream destinations around the world. 
						This page is more of a personal page, where I document my future travel ideas and itineraries.
					</p>
				</div>

				{planWithPosts.length > 0 ? (
					<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 items-stretch">
						{planWithPosts.map((planData) => (
							<div onclick={`location.href='/${planData.title.toLowerCase()}'`} class="bg-white rounded-xl overflow-hidden shadow-md hover:shadow-xl transition-shadow duration-300 cursor-pointer flex flex-col" >
								<div class="h-48 overflow-hidden">
									<img
										src={getPlanHeroImage(travelTitleToNormal(planData.title), defaultImage)}
										alt={planData.title}
										class="w-full h-full object-cover transition-transform duration-500 hover:scale-105"
									/>
								</div>
								<div class="p-6 flex flex-col flex-grow">
									<div class="flex items-center justify-between mb-3">
										<h3 class="title-font text-xl font-semibold text-gray-800 gap-3">
											{travelTitleToNormal(planData.title)}
										</h3>
										<span class="bg-pink-100 text-pink-600 px-2.5 py-1 rounded-full text-sm font-medium min-w-[72px]" >
											{planData.postCount} {planData.postCount === 1 ? 'post' : 'posts'}
										</span>
									</div>
									<p class="text-gray-600 flex-grow">
										{getPlanPreview(travelTitleToNormal(planData.title))}
									</p>
									<a href={`/${planData.title.toLowerCase()}`} class="mt-4 inline-block text-pink-500 hover:text-pink-700 font-medium">
										Read more here!
										<i class="fas fa-arrow-right ml-2"></i>
									</a>
								</div>
							</div>
						))}
					</div>
				) : (
					<p class="text-gray-600 text-center">No plans found.</p>
				)}
			</div>
		</main>
		<Footer />
	</body>
</html>
