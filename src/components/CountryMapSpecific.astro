---
import { getPostsWithCoordinatesForCountry } from '../utils/blog-db';
import { url } from '../utils/url';

export interface Props {
  countryName: string;
}

const { countryName } = Astro.props;

// Get posts with coordinates for this specific country
const postsWithCoords = await getPostsWithCoordinatesForCountry(countryName);
console.log(`Posts with coordinates for country ${countryName}:`, postsWithCoords);

// Filter out posts without coordinates and transform to expected format
const posts = postsWithCoords
  .filter(post => post.latitude && post.longitude)
  .map(post => ({
    id: post.id,
    title: post.title,
    postUrl: url(post.url), // Use the url utility function
    tags: post.tags,
    description: post.description,
    location: {
      name: post.locationName,
      country: post.countryName,
      lat: parseFloat(post.latitude!),
      lng: parseFloat(post.longitude!)
    }
  }));

// Country bounds for proper map centering and zoom
const countryBounds: Record<string, [[number, number], [number, number]]> = {
  'Belgium': [[49.4, 2.5], [51.5, 6.4]],
  'Netherlands': [[50.7, 3.2], [53.7, 7.2]], 
  'The Netherlands': [[50.7, 3.2], [53.7, 7.2]],
  'France': [[41.3, -5.1], [51.1, 9.6]],
  'Germany': [[47.3, 5.9], [55.1, 15.0]],
  'United Kingdom': [[49.9, -8.2], [60.9, 1.8]],
  'Spain': [[27.6, -18.2], [43.8, 4.3]],
  'Italy': [[35.5, 6.6], [47.1, 18.5]],
  'Switzerland': [[45.8, 5.9], [47.8, 10.5]],
  'Austria': [[46.4, 9.5], [49.0, 17.2]],
  // Add more countries as needed
};

console.log('Transformed posts for country map:', posts);
---

{posts.length > 0 && (
  <div class="travel-map-container">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
      <div class="text-center mb-8">
        <h2 class="title-font text-3xl font-semibold text-pink-400 mb-2">
          Journey Map
        </h2>
        <p class="text-gray-500 max-w-2xl mx-auto">
          Explore the locations I've visited in {countryName}
        </p>
      </div>
      <div id="country-specific-map" class="h-[500px] w-full max-w-4xl mx-auto rounded-2xl shadow-lg overflow-hidden border-0 bg-gradient-to-br from-pink-50 to-purple-50"></div>
    </div>
  </div>
)}

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script is:inline define:vars={{ posts, countryName, countryBounds }}>
  
  document.addEventListener('DOMContentLoaded', function() {
    
    // Check if Leaflet is loaded and we have posts
    if (typeof L === 'undefined' || !posts || posts.length === 0) {
      return;
    }
    
    // Initialize the map
    try {
      const map = L.map('country-specific-map', {
        scrollWheelZoom: false, // Disable scroll wheel zoom by default
        minZoom: 2, // Prevent zooming out beyond one world map
        maxZoom: 18, // Set reasonable maximum zoom
        maxBounds: [[-90, -180], [90, 180]], // Restrict panning to one world
        maxBoundsViscosity: 1.0 // Make the bounds "sticky" - prevents dragging outside
      });
      
      // Enhanced scroll control - only enable when map is clicked and focused
      const mapContainer = document.getElementById('country-specific-map');
      let mapIsActive = false;
      
      if (mapContainer) {
        // Enable scroll when user clicks on the map
        mapContainer.addEventListener('click', (e) => {
          e.stopPropagation(); // Prevent event bubbling
          mapIsActive = true;
          map.scrollWheelZoom.enable();
        });
        
        // Disable scroll when user clicks outside the map
        document.addEventListener('click', (e) => {
          if (!mapContainer.contains(e.target)) {
            mapIsActive = false;
            map.scrollWheelZoom.disable();
          }
        });
        
        // Disable scroll when mouse leaves the map area
        mapContainer.addEventListener('mouseleave', () => {
          if (mapIsActive) {
            mapIsActive = false;
            map.scrollWheelZoom.disable();
          }
        });
        
        // For touch devices - enable on touch start, disable on touch end outside
        let touchStarted = false;
        
        mapContainer.addEventListener('touchstart', (e) => {
          e.stopPropagation();
          touchStarted = true;
          mapIsActive = true;
          map.scrollWheelZoom.enable();
        });
        
        // Disable on touch outside the map
        document.addEventListener('touchstart', (e) => {
          if (!mapContainer.contains(e.target) && touchStarted) {
            mapIsActive = false;
            map.scrollWheelZoom.disable();
            touchStarted = false;
          }
        });
        
        // Also disable scroll on escape key for accessibility
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && mapIsActive) {
            mapIsActive = false;
            map.scrollWheelZoom.disable();
          }
        });
      }
      
      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);
      
      // Create custom country marker icon with a distinct style
      const countryIcon = L.divIcon({
        className: 'custom-country-marker',
        html: '<div class="marker-pin-country"></div>',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
      
      // Array to store markers for bounds fitting
      const markers = [];
      
      // Add markers for each post
      let markerCount = 0;
      
      posts.forEach(post => {
        const marker = L.marker([post.location.lat, post.location.lng], { icon: countryIcon }).addTo(map);
        
        // Create popup content
        const tagsHtml = post.tags.length > 0 
          ? `<div class="popup-tags">${post.tags.map(tag => `<span class="popup-tag">${tag}</span>`).join('')}</div>` 
          : '';
        
        const popupContent = `
          <div class="compact-popup">
            <h3 class="popup-title">${post.title.replace(/_/g, ' ')}</h3>
            <p class="popup-location">üìç ${post.location.name}, ${post.location.country}</p>
            ${tagsHtml}
            <p class="popup-description">${post.description}</p>
            <a href="${post.postUrl}" class="popup-link">Read Story ‚Üí</a>
          </div>
        `;
        
        marker.bindPopup(popupContent);
        markers.push(marker);
        markerCount++;
      });
      
      // Set appropriate zoom and bounds for the country
      if (markers.length > 0) {
        // Check if we have predefined bounds for this country
        const bounds = countryBounds[countryName];
        
        if (bounds) {
          // Use predefined country bounds to show the whole country
          map.fitBounds(bounds, { padding: [20, 20] });
        } else {
          // Fallback to marker-based bounds
          const group = new L.featureGroup(markers);
          const markerBounds = group.getBounds();
          
          if (markers.length === 1) {
            // For single marker, zoom out more to show country context
            map.setView([posts[0].location.lat, posts[0].location.lng], 8);
          } else {
            // For multiple markers, use bounds but with generous padding
            map.fitBounds(markerBounds.pad(0.3));
          }
        }
      }
      
    } catch (error) {
      console.error('Error initializing country map:', error);
    }
  });
</script>

<style>
  .travel-map-container {
    position: relative;
    width: 100%;
    background: transparent;
    z-index: 10;
    margin-top: 2rem;
  }

  /* Custom country marker styling - distinct from travel/plan markers */
  :global(.custom-country-marker) {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
  }

  :global(.marker-pin-country) {
    width: 20px;
    height: 20px;
    background: #f472b6;
    border: 3px solid #fff;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(244, 114, 182, 0.3);
    transition: all 0.2s ease;
    cursor: pointer;
    /* Add a country-specific styling - solid with border pattern */
    background: radial-gradient(circle, #f472b6 40%, #ec4899 70%);
    border: 3px solid #fce7f3;
  }

  :global(.marker-pin-country:hover) {
    background: radial-gradient(circle, #ec4899 40%, #db2777 70%);
    transform: scale(1.2);
    box-shadow: 0 4px 16px rgba(244, 114, 182, 0.5);
  }

  /* Popup styling - moderately compact layout */
  :global(.compact-popup) {
    padding: 8px !important;
    margin: 0 !important;
    min-width: 200px;
    max-width: 240px;
    font-size: 12px;
    line-height: 1.3;
  }

  :global(.popup-title) {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: #f472b6 !important;
    margin: 0 0 4px 0 !important;
    padding: 0 !important;
    line-height: 1.2 !important;
    font-family: inherit;
  }

  :global(.popup-location) {
    font-size: 11px !important;
    color: #6b7280 !important;
    margin: 0 0 4px 0 !important;
    padding: 0 !important;
    line-height: 1.2 !important;
  }

  :global(.popup-tags) {
    margin: 0 0 4px 0 !important;
    padding: 0 !important;
    line-height: 1.1 !important;
  }

  :global(.popup-tag) {
    display: inline-block;
    background: #fce7f3 !important;
    color: #be185d !important;
    font-size: 9px !important;
    padding: 2px 5px !important;
    margin: 0 3px 2px 0 !important;
    border-radius: 4px !important;
    font-weight: 500 !important;
    line-height: 1 !important;
  }

  :global(.popup-description) {
    font-size: 11px !important;
    color: #4b5563 !important;
    margin: 0 0 8px 0 !important;
    padding: 0 !important;
    line-height: 1.3 !important;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  :global(.popup-link) {
    display: inline-block !important;
    padding: 4px 10px !important;
    background: #f472b6 !important;
    color: white !important;
    text-decoration: none !important;
    border-radius: 12px !important;
    font-size: 11px !important;
    font-weight: 500 !important;
    transition: all 0.2s ease !important;
    margin: 0 !important;
  }

  :global(.popup-link:hover) {
    background: #ec4899 !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 8px rgba(244, 114, 182, 0.3) !important;
  }

  /* Override default Leaflet popup styling for compactness */
  :global(.leaflet-popup-content-wrapper) {
    border-radius: 8px !important;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15) !important;
    border: 1px solid #fce7f3 !important;
    padding: 0 !important;
  }

  :global(.leaflet-popup-content) {
    margin: 0 !important;
    padding: 0 !important;
    width: auto !important;
    min-height: auto !important;
  }

  :global(.leaflet-popup-tip) {
    border-top-color: #fce7f3 !important;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    #country-specific-map {
      height: 350px;
      max-width: 95vw;
    }
    
    :global(.compact-popup) {
      min-width: 180px !important;
      max-width: 200px !important;
      font-size: 11px !important;
      padding: 7px !important;
    }
    
    :global(.popup-title) {
      font-size: 13px !important;
    }
    
    :global(.popup-location) {
      font-size: 10px !important;
    }

    :global(.popup-tag) {
      font-size: 8px !important;
      padding: 2px 4px !important;
    }

    :global(.popup-description) {
      font-size: 10px !important;
    }
    
    :global(.popup-link) {
      padding: 4px 8px !important;
      font-size: 10px !important;
    }
  }
</style>
