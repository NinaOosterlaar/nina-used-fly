---
export interface Props {
  images: Array<{
    src: string;
    alt: string;
    description?: string;
  }>;
  maxWidth?: string;
  maxHeight?: string;
  id?: string;
  description?: string;
}

const { images, maxWidth = "500px", maxHeight = "400px", id = "carousel", description } = Astro.props;
const uniqueId = `${id}-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="image-carousel" style={`max-width: ${maxWidth}; margin: 2rem auto; text-align: center;`}>
  <div style="position: relative; overflow: hidden; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); background: #f9fafb;">
    <div id={`${uniqueId}-track`} style="display: flex; transition: transform 0.3s ease-in-out;">
      {images.map((image) => (
        <img 
          src={image.src}
          alt={image.alt}
          style={`width: 100%; max-height: ${maxHeight}; object-fit: contain; flex-shrink: 0;`}
        />
      ))}
    </div>
    
    <!-- Navigation Arrows (only show if more than 1 image) -->
    {images.length > 1 && (
      <>
        <button 
          id={`${uniqueId}-prev`}
          class="carousel-btn carousel-prev"
          aria-label="Previous image"
        >
          <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        
        <button 
          id={`${uniqueId}-next`}
          class="carousel-btn carousel-next"
          aria-label="Next image"
        >
          <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </>
    )}
  </div>
  
  <!-- Dots Indicator (only show if more than 1 image) -->
  {images.length > 1 && (
    <div style="display: flex; justify-content: center; margin-top: 12px; gap: 8px;">
      {images.map((_, index) => (
        <button 
          class={`${uniqueId}-dot carousel-dot`} 
          data-slide={index.toString()}
          style={`width: 12px; height: 12px; border-radius: 50%; border: none; cursor: pointer; background: ${index === 0 ? '#f472b6' : '#d1d5db'};`}
        ></button>
      ))}
    </div>
  )}
  
  <!-- Individual Image Description (only show if current image has a description) -->
  {images.some(img => img.description) && (
    <div id={`${uniqueId}-image-desc`} style="margin-top: 8px; min-height: 20px;">
      <p style="color: #6b7280; font-size: 14px; margin: 0; opacity: 0.9;">
        {images[0].description || ''}
      </p>
    </div>
  )}

  <!-- Optional General Description -->
  {description && (
    <p style="margin-top: 12px; color: #6b7280; font-style: italic; font-size: 14px; max-width: 400px; margin-left: auto; margin-right: auto;">
      {description}
    </p>
  )}
</div>

<style>
  .carousel-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(244, 114, 182, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    padding: 8px;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: background-color 0.2s ease;
  }
  
  .carousel-btn:hover {
    background: rgba(244, 114, 182, 1);
  }
  
  .carousel-prev {
    left: 10px;
  }
  
  .carousel-next {
    right: 10px;
  }
  
  .carousel-dot {
    transition: background-color 0.2s ease;
  }
  
  .carousel-dot:hover {
    background: #f9a8d4 !important;
  }
</style>

<script define:vars={{ uniqueId, totalSlides: images.length, imageDescriptions: images.map(img => img.description || '') }}>
  if (totalSlides > 1) {
    const carousel = document.getElementById(`${uniqueId}-track`);
    const prevBtn = document.getElementById(`${uniqueId}-prev`);
    const nextBtn = document.getElementById(`${uniqueId}-next`);
    const dots = document.querySelectorAll(`.${uniqueId}-dot`);
    const imageDescContainer = document.getElementById(`${uniqueId}-image-desc`);
    
    let currentSlide = 0;
    
    function updateCarousel() {
      const translateX = -currentSlide * 100;
      carousel.style.transform = `translateX(${translateX}%)`;
      
      dots.forEach((dot, index) => {
        if (index === currentSlide) {
          dot.style.background = '#f472b6';
        } else {
          dot.style.background = '#d1d5db';
        }
      });
      
      // Update individual image description
      if (imageDescContainer) {
        const descParagraph = imageDescContainer.querySelector('p');
        if (descParagraph) {
          descParagraph.textContent = imageDescriptions[currentSlide] || '';
          descParagraph.style.opacity = imageDescriptions[currentSlide] ? '0.9' : '0';
        }
      }
    }
    
    function nextSlide() {
      currentSlide = (currentSlide + 1) % totalSlides;
      updateCarousel();
    }
    
    function prevSlide() {
      currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
      updateCarousel();
    }
    
    function goToSlide(slideIndex) {
      currentSlide = slideIndex;
      updateCarousel();
    }
    
    if (prevBtn && nextBtn) {
      prevBtn.addEventListener('click', prevSlide);
      nextBtn.addEventListener('click', nextSlide);
    }
    
    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => goToSlide(index));
    });
    
    // Initialize the first image description
    updateCarousel();
  } else {
    // Handle single image description display
    const imageDescContainer = document.getElementById(`${uniqueId}-image-desc`);
    if (imageDescContainer && imageDescriptions[0]) {
      const descParagraph = imageDescContainer.querySelector('p');
      if (descParagraph) {
        descParagraph.textContent = imageDescriptions[0];
        descParagraph.style.opacity = '0.9';
      }
    }
  }
</script>
