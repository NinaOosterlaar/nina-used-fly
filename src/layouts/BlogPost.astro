---
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import TableOfContents from "../components/TableOfContents.astro";
import ScrollToTop from "../components/ScrollToTop.astro";
import {
	getBlogPostByTitle,
	linkPostToTravel,
	getNextPreviousPosts,
	type BlogPostMetadata,
	type NavigationPost,
} from "../utils/blog-db";
import { resolveImageUrl } from "../utils/image";

type Props = CollectionEntry<"blog">["data"] & {
	headings?: { depth: number; slug: string; text: string }[];
};

const { title, description, pubDate, updatedDate, heroImage } = Astro.props;

// Get the folder path from the current URL for travel linking
const currentPath = Astro.url.pathname;
const folderPath = currentPath.split("/").slice(-2, -1)[0]; // Get the folder name

// console.log(`Processing blog post: ${title}`);
// console.log(`Folder path: ${folderPath}`);

// Fetch metadata from database
let dbMetadata: BlogPostMetadata | null = null;
try {
	dbMetadata = await getBlogPostByTitle(title, folderPath);

	// Link to travel if we have a folder path and the post exists
	if (dbMetadata && folderPath && folderPath !== "blog") {
		await linkPostToTravel(title, folderPath);
		// Refetch to get updated travel info
		dbMetadata = await getBlogPostByTitle(title, folderPath);
	}
} catch (error) {
	console.error("Error fetching blog post metadata:", error);
}

// Use database dates if available, fallback to frontmatter
const displayPubDate = dbMetadata?.startDate
	? new Date(dbMetadata.startDate)
	: pubDate;
const displayUpdatedDate = dbMetadata?.updatedAt
	? new Date(dbMetadata.updatedAt)
	: updatedDate;
const displayEndDate = dbMetadata?.endDate
	? new Date(dbMetadata.endDate)
	: null;

// Always show either updated date or created date
const finalUpdateDate = displayUpdatedDate || (dbMetadata?.createdAt ? new Date(dbMetadata.createdAt) : displayPubDate);
const isActuallyUpdated = !!displayUpdatedDate;

// Fetch next and previous posts for navigation
let navigation: { next: NavigationPost | null; previous: NavigationPost | null } = { next: null, previous: null };
try {
	navigation = await getNextPreviousPosts(title, folderPath);
} catch (error) {
	console.error("Error fetching navigation posts:", error);
}

// console.log("Database metadata:", dbMetadata);
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
		<style>
			body {
				background: linear-gradient(to bottom, #fdf2f8, #ffffff);
				min-height: 100vh;
			}
			main {
				width: 100%;
				max-width: 100%;
				margin: 0;
			}
			.hero-section {
				background: linear-gradient(
					135deg,
					#fdf2f8 0%,
					#ffffff 50%,
					#fef7f0 100%
				);
				padding: 3rem 0 1rem 0;
				position: relative;
				overflow: hidden;
			}
			.hero-section::before {
				content: "";
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: linear-gradient(
					to bottom,
					transparent,
					rgba(255, 255, 255, 0.2)
				);
				pointer-events: none;
			}
			.hero-content {
				max-width: 1200px;
				margin: 0 auto;
				padding: 0 2rem;
				position: relative;
				z-index: 1;
			}
			.hero-image {
				width: 100%;
				max-width: 800px;
				max-height: 400px;
				margin: 0 auto 2rem auto;
				border-radius: 20px;
				overflow: hidden;
				box-shadow: 0 20px 40px rgba(244, 114, 182, 0.15);
				transition:
					transform 0.3s ease,
					box-shadow 0.3s ease;
			}
			.hero-image:hover {
				transform: translateY(-4px);
				box-shadow: 0 25px 50px rgba(244, 114, 182, 0.2);
			}
			.hero-image img {
				display: block;
				width: 100%;
				height: 100%;
				max-height: 400px;
				border-radius: 20px;
				object-fit: cover;
			}
			.blog-header {
				text-align: center;
				margin-bottom: 3rem;
			}
			.blog-meta {
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 1rem;
				margin-bottom: 1.5rem;
				font-size: 0.9rem;
				color: #f472b6;
				flex-wrap: wrap;
			}
			.blog-meta .date {
				display: flex;
				align-items: center;
				gap: 0.5rem;
			}
			.blog-meta .location {
				display: flex;
				align-items: center;
				gap: 0.5rem;
			}
			.blog-meta .travel-info {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				font-style: italic;
			}
			.blog-meta .travel-link {
				color: #f472b6;
				text-decoration: none;
				font-weight: 500;
				transition: all 0.3s ease;
				border-bottom: 1px solid transparent;
			}
			.blog-meta .travel-link:hover {
				color: #ec4899;
				border-bottom-color: #ec4899;
				text-shadow: 0 0 8px rgba(244, 114, 182, 0.3);
			}
			.blog-meta .separator {
				color: #f472b6;
				opacity: 0.6;
			}
			.blog-tags {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5rem;
				justify-content: center;
				margin: 1.5rem 0;
			}
			.tag {
				background: linear-gradient(135deg, #f472b6, #ec4899);
				color: white;
				padding: 0.4rem 0.8rem;
				border-radius: 20px;
				font-size: 0.8rem;
				font-weight: 500;
				text-decoration: none;
				transition: all 0.2s ease;
			}
			.tag:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 12px rgba(244, 114, 182, 0.3);
			}
			.blog-title {
				font-size: 3rem;
				font-weight: bold;
				color: #f472b6;
				margin: 0 0 1rem 0;
				line-height: 1.2;
				font-family:
					system-ui,
					-apple-system,
					sans-serif;
			}
			.blog-description {
				font-size: 1.2rem;
				color: #6b7280;
				max-width: 600px;
				margin: 0 auto 2rem auto;
				line-height: 1.6;
			}
			.blog-divider {
				width: 60px;
				height: 3px;
				background: linear-gradient(to right, #f472b6, #ec4899);
				border: none;
				border-radius: 2px;
				margin: 0 auto;
			}
			.content-wrapper {
				background: linear-gradient(
					135deg,
					#fdf2f8 0%,
					#ffffff 50%,
					#fef7f0 100%
				);
				border-radius: 24px;
				box-shadow: 0 4px 20px rgba(244, 114, 182, 0.05);
				margin: 2rem auto;
				max-width: 800px;
				overflow: hidden;
				position: relative;
			}
			.content-wrapper::before {
				content: "";
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: linear-gradient(
					to bottom,
					transparent,
					rgba(255, 255, 255, 0.1)
				);
				pointer-events: none;
			}
			.prose {
				max-width: none;
				margin: 0;
				padding: 0rem 3rem 3rem 3rem;
				color: #374151;
				line-height: 1.7;
				font-size: 1.1rem;
				position: relative;
				z-index: 1;
			}
			.last-updated {
				background: #fef7f0;
				padding: 1rem 1.5rem;
				border-radius: 12px;
				border-left: 4px solid #f472b6;
				margin: 2rem 0;
				font-style: italic;
				color: #6b7280;
				font-size: 0.9rem;
			}

			.toc-container {
				max-width: 800px;
				margin: 0 auto;
				padding: 0 2rem;
			}

			/* Navigation arrows styles */
			.post-navigation {
				position: fixed;
				top: 50%;
				transform: translateY(-50%);
				left: 0;
				right: 0;
				z-index: 100;
				pointer-events: none;
			}

			.nav-arrow {
				position: absolute;
				background: linear-gradient(135deg, #f472b6, #ec4899);
				border: none;
				border-radius: 50%;
				width: 50px;
				height: 50px;
				display: flex;
				align-items: center;
				justify-content: center;
				box-shadow: 0 4px 20px rgba(244, 114, 182, 0.3);
				cursor: pointer;
				transition: all 0.3s ease;
				pointer-events: auto;
				text-decoration: none;
				color: white;
			}

			.nav-arrow:hover {
				transform: scale(1.1);
				box-shadow: 0 6px 30px rgba(244, 114, 182, 0.5);
				color: white;
				text-decoration: none;
			}

			.nav-arrow svg {
				width: 20px;
				height: 20px;
				fill: currentColor;
			}

			.nav-previous {
				left: 3rem;
			}

			.nav-next {
				right: 3rem;
			}

			/* Tooltip styles - Beautiful preview tooltips */
			.nav-arrow .preview-tooltip {
				position: absolute;
				background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(253, 242, 248, 0.95));
				color: #374151;
				border: 1px solid rgba(244, 114, 182, 0.2);
				border-radius: 12px;
				padding: 1rem;
				font-size: 0.85rem;
				opacity: 0;
				visibility: hidden;
				transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
				z-index: 101;
				width: 220px;
				pointer-events: none;
				backdrop-filter: blur(12px);
				white-space: normal;
				box-shadow: 
					0 10px 25px rgba(244, 114, 182, 0.15),
					0 4px 12px rgba(0, 0, 0, 0.1);
				transform-origin: center;
				scale: 0.95;
			}

			.nav-previous .preview-tooltip {
				left: calc(100% + 1rem);
				top: 50%;
				transform: translateY(-50%) scale(0.95);
			}

			.nav-next .preview-tooltip {
				right: calc(100% + 1rem);
				top: 50%;
				transform: translateY(-50%) scale(0.95);
			}

			.nav-arrow:hover .preview-tooltip {
				opacity: 1;
				visibility: visible;
				scale: 1;
				transform: translateY(-50%) scale(1);
			}

			/* Add a subtle arrow pointer */
			.nav-previous .preview-tooltip::before {
				content: '';
				position: absolute;
				left: -6px;
				top: 50%;
				transform: translateY(-50%);
				width: 0;
				height: 0;
				border-style: solid;
				border-width: 6px 6px 6px 0;
				border-color: transparent rgba(244, 114, 182, 0.2) transparent transparent;
			}

			.nav-next .preview-tooltip::before {
				content: '';
				position: absolute;
				right: -6px;
				top: 50%;
				transform: translateY(-50%);
				width: 0;
				height: 0;
				border-style: solid;
				border-width: 6px 0 6px 6px;
				border-color: transparent transparent transparent rgba(244, 114, 182, 0.2);
			}

			.preview-tooltip .tooltip-label {
				color: #f472b6;
				font-size: 0.7rem;
				font-weight: 700;
				text-transform: uppercase;
				letter-spacing: 1px;
				margin-bottom: 0.5rem;
				opacity: 0.8;
			}

			.preview-tooltip .tooltip-title {
				font-weight: 600;
				margin-bottom: 0.6rem;
				line-height: 1.3;
				color: #4b5563;
				font-size: 0.9rem;
			}

			.preview-tooltip .tooltip-location {
				color: #6b7280;
				font-size: 0.8rem;
				display: flex;
				align-items: center;
				gap: 0.4rem;
				padding: 0.3rem 0.5rem;
				background: rgba(244, 114, 182, 0.1);
				border-radius: 6px;
				margin-top: 0.4rem;
			}

			.preview-tooltip .tooltip-location svg {
				width: 14px;
				height: 14px;
				fill: #f472b6;
			}

			@media (max-width: 768px) {
				.hero-content {
					padding: 0 1rem;
				}
				.blog-title {
					font-size: 2.2rem;
				}
				.prose {
					padding: 2rem 1.5rem;
				}
				.blog-meta {
					font-size: 0.8rem;
				}
				.toc-container {
					padding: 0 1rem;
				}

				/* Mobile navigation adjustments */
				.nav-arrow {
					width: 40px;
					height: 40px;
					opacity: 0.7; /* Make more transparent on mobile */
					background: linear-gradient(135deg, rgba(244, 114, 182, 0.8), rgba(236, 72, 153, 0.8));
					box-shadow: 0 2px 10px rgba(244, 114, 182, 0.2);
				}

				.nav-arrow:hover {
					opacity: 0.9; /* Still maintain some transparency on hover */
					transform: scale(1.05); /* Less dramatic scale on mobile */
					box-shadow: 0 4px 15px rgba(244, 114, 182, 0.3);
				}

				.nav-arrow svg {
					width: 16px;
					height: 16px;
				}

				.nav-previous {
					left: 1rem;
				}

				.nav-next {
					right: 1rem;
				}

				/* Hide preview tooltips on mobile */
				.nav-arrow .preview-tooltip {
					display: none;
				}
			}
		</style>
	</head>
	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QVH8372V0"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-9QVH8372V0');
	</script>

	<body>
		<Header />
		<main>
			<div class="hero-section">
				<div class="hero-content">
					{
						heroImage && (
							<div class="hero-image">
								<img
									width="1020"
									height="510"
									src={resolveImageUrl(heroImage)}
									alt={title}
									style="width: 100%; height: auto; object-fit: cover;"
								/>
							</div>
						)
					}

					<div class="blog-header">
						<div class="blog-meta">
							<div class="date">
								<svg
									width="16"
									height="16"
									fill="currentColor"
									viewBox="0 0 24 24"
								>
									<path
										d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"
									></path>
								</svg>
								{
									displayEndDate ? (
										<span>
											<FormattedDate
												date={displayPubDate}
											/>{" "}
											-{" "}
											<FormattedDate
												date={displayEndDate}
											/>
										</span>
									) : (
										<FormattedDate date={displayPubDate} />
									)
								}
							</div>
							{
								dbMetadata?.location && (
									<>
										<span class="separator">•</span>
										<div class="location">
											<svg
												width="16"
												height="16"
												fill="currentColor"
												viewBox="0 0 24 24"
											>
												<path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
											</svg>
											{dbMetadata.location}
										</div>
									</>
								)
							}
							{
								dbMetadata?.travelTitle && (
									<>
										<span class="separator">•</span>
										<div class="travel-info">
											<svg
												width="16"
												height="16"
												fill="currentColor"
												viewBox="0 0 24 24"
											>
												<path d="M6.5,12C5.67,12 5,12.67 5,13.5C5,14.33 5.67,15 6.5,15C7.33,15 8,14.33 8,13.5C8,12.67 7.33,12 6.5,12M17.5,12C16.67,12 16,12.67 16,13.5C16,14.33 16.67,15 17.5,15C18.33,15 19,14.33 19,13.5C19,12.67 18.33,12 17.5,12M18.92,6.01C18.72,5.42 18.16,5 17.5,5H15L13.5,2H10.5L9,5H6.5C5.84,5 5.28,5.42 5.08,6.01L4,10V16C4,17.1 4.9,18 6,18V19C6,19.55 6.45,20 7,20H8C8.55,20 9,19.55 9,19V18H15V19C15,19.55 15.45,20 16,20H17C17.55,20 17,19.55 17,19V18C18.1,18 19,17.1 19,16V10L18.92,6.01Z" />
											</svg>
											Part of{" "}
											<a 
												href={`/${dbMetadata.travelTitle.toLowerCase()}`}
												class="travel-link"
											>
												{dbMetadata.travelTitle.replace(
													/_/g,
													" ",
												)}
											</a>
										</div>
									</>
								)
							}
							{
								dbMetadata?.planTitle && (
									<>
										<span class="separator">•</span>
										<div class="travel-info">
											<svg
												width="16"
												height="16"
												fill="currentColor"
												viewBox="0 0 24 24"
											>
												<path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2.5-5H18V4c0-.55-.45-1-1-1h-1c-.55 0-1 .45-1 1v2H9V4c0-.55-.45-1-1-1H7c-.55 0-1 .45-1 1v2H4.5c-.83 0-1.5.67-1.5 1.5v11c0 .83.67 1.5 1.5 1.5h15c.83 0 1.5-.67 1.5-1.5v-11c0-.83-.67-1.5-1.5-1.5z" />
											</svg>
											Part of plan:{" "}
											<a 
												href={`/${dbMetadata.planTitle.toLowerCase()}`}
												class="travel-link"
											>
												{dbMetadata.planTitle.replace(
													/_/g,
													" ",
												)}
											</a>
										</div>
									</>
								)
							}
							<>
								<span class="separator">•</span>
								<div class="date">
									<svg
										width="16"
										height="16"
										fill="currentColor"
										viewBox="0 0 24 24"
									>
										<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
									</svg>
									{isActuallyUpdated ? "Updated" : "Created"}{" "}
									<FormattedDate
										date={finalUpdateDate}
									/>
								</div>
							</>
						</div>

						<h1 class="blog-title">{title}</h1>

						{
							dbMetadata?.tags && dbMetadata.tags.length > 0 && (
								<div class="blog-tags">
									{dbMetadata.tags.map((tag) => (
										<a href={`/${tag.toLowerCase().replace(/ /g, '-')}`} class="tag">#{tag}</a>
									))}
								</div>
							)
						}

						<p class="blog-description">{description}</p>

						<hr class="blog-divider" />
					</div>
				</div>
			</div>

			<!-- Table of Contents -->
			<div class="toc-container">
				<TableOfContents headings={Astro.props.headings || []} />
			</div>

			<div class="content-wrapper">
				<article class="prose">
					<slot />
				</article>
			</div>

			<!-- Post Navigation -->
			<div class="post-navigation">
				{navigation.previous && (
					<a 
						href={navigation.previous.url} 
						class="nav-arrow nav-previous"
						aria-label={`Previous post: ${navigation.previous.title}`}
					>
						<svg viewBox="0 0 24 24">
							<path d="M15.41 16.58L10.83 12L15.41 7.42L14 6L8 12L14 18L15.41 16.58Z" />
						</svg>
						<div class="preview-tooltip">
							<div class="tooltip-label">Previous Post</div>
							<div class="tooltip-title">{navigation.previous.title}</div>
							{navigation.previous.location && (
								<div class="tooltip-location">
									<svg viewBox="0 0 24 24">
										<path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
									</svg>
									{navigation.previous.location}
								</div>
							)}
						</div>
					</a>
				)}
				{navigation.next && (
					<a 
						href={navigation.next.url} 
						class="nav-arrow nav-next"
						aria-label={`Next post: ${navigation.next.title}`}
					>
						<svg viewBox="0 0 24 24">
							<path d="M8.59 16.58L13.17 12L8.59 7.42L10 6L16 12L10 18L8.59 16.58Z" />
						</svg>
						<div class="preview-tooltip">
							<div class="tooltip-label">Next Post</div>
							<div class="tooltip-title">{navigation.next.title}</div>
							{navigation.next.location && (
								<div class="tooltip-location">
									<svg viewBox="0 0 24 24">
										<path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
									</svg>
									{navigation.next.location}
								</div>
							)}
						</div>
					</a>
				)}
			</div>
		</main>
		<Footer />
		<ScrollToTop />
	</body>
</html>
